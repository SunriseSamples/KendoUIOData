@using KendoUI.Models;
<div id="body">
    <section class="content-wrapper clear-fix">
        <h3>Telerik Kendo UI Core</h3>
        <div id="clientsDb">
            @{
                // 参考：
                // http://blogs.telerik.com/kendoui/posts/11-08-25/shields_up_web_service_abstraction_with_kendo_ui
                // http://blogs.telerik.com/kendoui/posts/12-10-25/using_kendo_ui_with_mvc4_webapi_odata_and_ef
                var serviceBaseUrl = "http://localhost:9171/odata/Products";
            }
            @(Html.Kendo().Grid<ProductViewModel>()
                .Name("grid")
                .Columns(columns =>
                {
                    //columns.Bound(c => c.ID).Width(140);
                    columns.Bound(c => c.Name).Width(140).Title("名称");
                    columns.Bound(c => c.Price).Width(190).Title("价格");
                    columns.Bound(c => c.Category).Width(110).Title("类别");
                    columns.Command(command => { command.Edit(); command.Destroy(); }).Width(160).Title("操作");
                })
                .ToolBar(toolbar => toolbar.Create())
                .Editable(editable => editable.Mode(GridEditMode.PopUp)
                    //.TemplateName("")
                )
                .HtmlAttributes(new { style = "height: 380px;" })
                .Scrollable()
                .Pageable(pageable => pageable
                    .Refresh(true)
                    .PageSizes(true)
                    .ButtonCount(10)
                )
                .Sortable()
                .Filterable()
                .Groupable()
                .DataSource(dataSource => dataSource
                    .Custom()
                    .Type("odata")
                    .Schema(schema => schema
                        .Model(m => m.Id(p => p.ID))
                        .Type("json")
                        .Data("value")
                        .Total(data => "function (data) { return data['odata.count']; }")
                        //.Errors()
                    )
                    .Transport(transport => transport
                        .Create(create => create.Url(serviceBaseUrl).Type(HttpVerbs.Post))
                        .Read(read => read.Url(serviceBaseUrl).Cache(true).DataType("json"))
                        .Update(update => update.Url(serviceBaseUrl).Type(HttpVerbs.Put).Data("changeUrl"))
                        .Destroy(destroy => destroy.Url(serviceBaseUrl).Type(HttpVerbs.Delete).Data("changeUrl"))
                        .ParameterMap("parameterMap")
                    )
                    .PageSize(10)
                    .ServerPaging(true)
                    .ServerSorting(true)
                    .ServerFiltering(true)
                    //.ServerGrouping(true)
                    .Events(events => events.Error("errorHandler"))
                )
            )
        </div>

        <style scoped>
            #clientsDb {
                width: 952px;
                height: 396px;
                margin: 20px auto 0;
                padding: 51px 4px 0 4px;
            }
@*                background: url('@Url.Content("~/content/web/grid/clientsDb.png")') no-repeat 0 0;*@
        </style>
        <script type="text/javascript">
            function changeUrl(data) {
                this.url = "@(serviceBaseUrl)" + "(" + data.ID + ")";
                return data;
            }

            function parameterMap(data, type) {
                //var parameters = "\n";
                //parameters += "data = " + JSON.stringify(data) + "\n";
                //parameters += "type = " + JSON.stringify(type) + "\n";
                //alert("parameterMap(" + parameters + ")");
                var result = kendo.data.transports.odata.parameterMap(data, type);
                //alert("result = " + JSON.stringify(result));
                if (result) {
                    delete result.$format;        // <-- remove format parameter.
                    //delete result.$inlinecount;   // <-- remove inlinecount parameter.
                    //result.$count = true;
                }
                //$("#message").html(JSON.stringify(result));
                return result;
            }

            function errorHandler(e) {
                //$("#message").html(e.xhr.responseText);
                var message = e.xhr.responseJSON["odata.error"].message.value;
                var innerMessage = e.xhr.responseJSON["odata.error"].innererror.message;
                alert(message + "\n" + innerMessage);
            }
        </script>
        <p id="message" />
    </section>
</div>
